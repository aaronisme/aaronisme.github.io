<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="天价交易费的分析与思考-如何复现一笔交易费为7676ETH的交易" /><meta property="og:locale" content="en" /><meta name="description" content="天价交易费的分析与思考-如何复现一笔交易费为7676ETH的交易" /><meta property="og:description" content="天价交易费的分析与思考-如何复现一笔交易费为7676ETH的交易" /><link rel="canonical" href="https://aaronchen.me/posts/tx-fee/" /><meta property="og:url" content="https://aaronchen.me/posts/tx-fee/" /><meta property="og:site_name" content="AARONCHEN" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-10-01T19:15:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="天价交易费的分析与思考-如何复现一笔交易费为7676ETH的交易" /><meta name="twitter:site" content="@aaron1sme" /> <script type="application/ld+json"> {"datePublished":"2021-10-01T19:15:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://aaronchen.me/posts/tx-fee/"},"description":"天价交易费的分析与思考-如何复现一笔交易费为7676ETH的交易","url":"https://aaronchen.me/posts/tx-fee/","@type":"BlogPosting","headline":"天价交易费的分析与思考-如何复现一笔交易费为7676ETH的交易","dateModified":"2022-01-11T13:14:58+08:00","@context":"https://schema.org"}</script><title>天价交易费的分析与思考-如何复现一笔交易费为7676ETH的交易 | AARONCHEN</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-touch.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="AARONCHEN"><meta name="application-name" content="AARONCHEN"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/favicons/avatar-ac-2.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">AARONCHEN</a></div><div class="site-subtitle font-italic">Learning, Thinking, Building</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/aaronisme" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/aaron1sme" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['aarondongchen','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>天价交易费的分析与思考-如何复现一笔交易费为7676ETH的交易</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>天价交易费的分析与思考-如何复现一笔交易费为7676ETH的交易</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/aaron1sme">Aaron Chen</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2021-10-01 19:15:00 +0800" data-toggle="tooltip" data-placement="bottom" title="Fri, Oct 1, 2021, 7:15 PM +0800" >Oct 1, 2021</em> </span> <span> Updated <em class="timeago" date="2022-01-11 13:14:58 +0800 " data-toggle="tooltip" data-placement="bottom" title="Tue, Jan 11, 2022, 1:14 PM +0800" >Jan 11, 2022</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1594 words"> <em>8 min</em> read</span></div></div></div><div class="post-content"><h1 id="天价交易费的分析与思考-如何复现一笔交易费为7676eth的交易">天价交易费的分析与思考-如何复现一笔交易费为7676ETH的交易</h1><p>2021年9月27号一笔<a href="https://etherscan.io/tx/0x2c9931793876db33b1a9aad123ad4921dfb9cd5e59dbb78ce78f277759587115">7676ETH的交易</a>的出现引爆了整个加密货币社区.到底是什么原因出现的这一笔交易引起了诸多猜测。2天后也是9月29号交易的发出者Deversifi在其网站上纰漏了更多细节，以及事故分析。</p><p>作为一名老前端者，安全研究爱好者，作者第一时间阅读了这片文章。下边带大家一探究竟尝试解释一下这笔交易的由来。</p><h2 id="背景">背景<a href="#背景" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>Deversifi在不久之前讲交易类型升级到EIP-1559的交易，并且它的前端支持连接Metamask和Ledger两种钱包。然而这两种钱包交易构建的方法是非常不同，对于Metamask来说，交易构建是Metamask来负责的，Dapp开发者基本不用操作什么。而对于ledger来说，Dapp需要自己构建交易，构建完成后传给Ledger进行交易的签名。目前Dapp开发者基本都会使用<a href="https://github.com/ethereumjs/ethereumjs-monorepo">“@ethereumjs/tx”</a> 来构建交易。下边就是官方文档给出的构建交易的事例代码。</p><div class="language-js highlighter-rouge"><div class="code-header"> <span label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="k">import</span> <span class="nx">Common</span><span class="p">,</span> <span class="p">{</span> <span class="nx">Chain</span><span class="p">,</span> <span class="nx">Hardfork</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@ethereumjs/common</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">FeeMarketEIP1559Transaction</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@ethereumjs/tx</span><span class="dl">'</span>

<span class="kd">const</span> <span class="nx">common</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Common</span><span class="p">({</span> <span class="na">chain</span><span class="p">:</span> <span class="nx">Chain</span><span class="p">.</span><span class="nx">Mainnet</span><span class="p">,</span> <span class="na">hardfork</span><span class="p">:</span> <span class="nx">Hardfork</span><span class="p">.</span><span class="nx">London</span> <span class="p">})</span>

<span class="kd">const</span> <span class="nx">txData</span> <span class="o">=</span> <span class="p">{</span>
  <span class="dl">"</span><span class="s2">data</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">0x1a8451e600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">gasLimit</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">0x02625a00</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">maxPriorityFeePerGas</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">0x01</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">maxFeePerGas</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">0xff</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">nonce</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">0x00</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">to</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">0xcccccccccccccccccccccccccccccccccccccccc</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">value</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">0x0186a0</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">v</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">0x01</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">r</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">0xafb6e247b1c490e284053c87ab5f6b59e219d51f743f7a4d83e400782bc7e4b9</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">s</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">0x479a268e0e0acd4de3f1e28e4fac2a6b32a4195e8dfa9d19147abe8807aa6f64</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">chainId</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">0x01</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">accessList</span><span class="dl">"</span><span class="p">:</span> <span class="p">[],</span>
  <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">0x02</span><span class="dl">"</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">tx</span> <span class="o">=</span> <span class="nx">FeeMarketEIP1559Transaction</span><span class="p">.</span><span class="nx">fromTxData</span><span class="p">(</span><span class="nx">txData</span><span class="p">,</span> <span class="p">{</span> <span class="nx">common</span> <span class="p">})</span>
</pre></table></code></div></div><h2 id="一探究竟">一探究竟<a href="#一探究竟" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>从例子上看似乎没什么问题，只要将txData的参数传对，应该也不会出现什么问题。那到底这个天价交易是如何出现的？我们来通过代码一探究竟。</p><div class="language-ts highlighter-rouge"><div class="code-header"> <span label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="kd">constructor</span><span class="p">(</span><span class="nx">txData</span><span class="p">:</span> <span class="nx">FeeMarketEIP1559TxData</span><span class="p">,</span> <span class="nx">opts</span><span class="p">:</span> <span class="nx">TxOptions</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">{</span>
    <span class="p">...</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">maxFeePerGas</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BN</span><span class="p">(</span><span class="nx">toBuffer</span><span class="p">(</span><span class="nx">maxFeePerGas</span> <span class="o">===</span> <span class="dl">''</span> <span class="p">?</span> <span class="dl">'</span><span class="s1">0x</span><span class="dl">'</span> <span class="p">:</span> <span class="nx">maxFeePerGas</span><span class="p">))</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">maxPriorityFeePerGas</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BN</span><span class="p">(</span>
      <span class="nx">toBuffer</span><span class="p">(</span><span class="nx">maxPriorityFeePerGas</span> <span class="o">===</span> <span class="dl">''</span> <span class="p">?</span> <span class="dl">'</span><span class="s1">0x</span><span class="dl">'</span> <span class="p">:</span> <span class="nx">maxPriorityFeePerGas</span><span class="p">)</span>
    <span class="p">)</span>
</pre></table></code></div></div><p>上边是FeeMarketEIP1559Transaction的constructor函数，我们注意maxPriorityFeePerGas和maxFeePerGas都是将传入的<strong>字符串</strong>转成Buffer对象，然后创建了一个BN的对象用于后续计算。从文档中看@ethereumjs/tx的开发者应该是期望上述两个参数都应是string类型，并且源码中的类型声明也是这么定义的 https://github.com/ethereumjs/ethereumjs-monorepo/blob/b0477d64c259b354ff57bab7e77be43081216fea/packages/tx/src/types.ts#L263:3</p><p>那么如果传入的类型如果不是string那么会发生什么？如果传入的是一个浮点数会发生什么？从Deversifi的事故分析中我们应该也能看到，他们应该传入的并不是string，而是浮点数。要回答这个问题我们就得进入toBuffer方法中看看了。</p><p>toBuffer方法是定义在ethereumjs-util中的下边是其代码片段。</p><div class="language-js highlighter-rouge"><div class="code-header"> <span label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre><span class="c1">// ethereumjs-util</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">intToBuffer</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">ethjs-util</span><span class="dl">'</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">toBuffer</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">v</span><span class="p">:</span> <span class="nx">ToBufferInputTypes</span><span class="p">):</span> <span class="nx">Buffer</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">v</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">number</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">intToBuffer</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ethjs-util</span>
<span class="c1">// https://github.com/ethjs/ethjs-util/blob/e9aede668177b6d1ea62d741ba1c19402bc337b3/src/index.js#L39</span>
<span class="cm">/**
 * Converts a `Number` into a hex `String`
 * @param {Number} i
 * @return {String}
 */</span>

<span class="kd">function</span> <span class="nx">padToEven</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span> <span class="c1">// eslint-disable-line</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">a</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">`[ethjs-util] while padding to even, value must be string, is currently </span><span class="p">${</span><span class="k">typeof</span> <span class="nx">a</span><span class="p">}</span><span class="s2">, while padToEven.`</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">a</span> <span class="o">=</span> <span class="s2">`0</span><span class="p">${</span><span class="nx">a</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">intToHex</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">hex</span> <span class="o">=</span> <span class="nx">i</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span> <span class="c1">// eslint-disable-line</span>

  <span class="k">return</span> <span class="s2">`0x</span><span class="p">${</span><span class="nx">hex</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**
 * Converts an `Number` to a `Buffer`
 * @param {Number} i
 * @return {Buffer}
 */</span>
<span class="kd">function</span> <span class="nx">intToBuffer</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">hex</span> <span class="o">=</span> <span class="nx">intToHex</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>

  <span class="k">return</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">padToEven</span><span class="p">(</span><span class="nx">hex</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span> <span class="dl">'</span><span class="s1">hex</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>从代码中可以发现，如果传入的是一个浮点数，那么它会被先按十六进制转成字符串，补0使得字符串长度为偶数后用来生成对应的Buffer。例如1.53125在toString(16)就会变为’1.88’，到这一步为止一个浮点数被变为字符串。</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>var a = 1.53125
a.toString(16) 
'1.88'
</pre></table></code></div></div><p>下一步才是真正的问题所在。</p><h2 id="问题根本">问题根本<a href="#问题根本" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>下一步就是这个Buffer如何生成的了。因为Buffer是Node.js中数据类型，所以在浏览器中一般会引入响应的polyfill，用的最多的是<a href="https://github.com/feross/buffer">feross/buffer</a>, ethjs-util正是使用的是它。</p><div class="language-js highlighter-rouge"><div class="code-header"> <span label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="c1">// feross/buffer</span>
<span class="c1">// https://github.com/feross/buffer/blob/master/index.js#L828:10</span>
<span class="p">..</span> 
<span class="kd">function</span> <span class="nx">hexWrite</span> <span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">offset</span><span class="p">,</span> <span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">offset</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">offset</span><span class="p">)</span> <span class="o">||</span> <span class="mi">0</span>
  <span class="kd">const</span> <span class="nx">remaining</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">offset</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">length</span> <span class="o">=</span> <span class="nx">remaining</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">length</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">length</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">remaining</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">length</span> <span class="o">=</span> <span class="nx">remaining</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">strLen</span> <span class="o">=</span> <span class="nx">string</span><span class="p">.</span><span class="nx">length</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">strLen</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">length</span> <span class="o">=</span> <span class="nx">strLen</span> <span class="o">/</span> <span class="mi">2</span>
  <span class="p">}</span>
  <span class="kd">let</span> <span class="nx">i</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">parsed</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">string</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">numberIsNaN</span><span class="p">(</span><span class="nx">parsed</span><span class="p">))</span> <span class="k">return</span> <span class="nx">i</span>
    <span class="nx">buf</span><span class="p">[</span><span class="nx">offset</span> <span class="o">+</span> <span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parsed</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">i</span>
<span class="p">}</span>
</pre></table></code></div></div><p>对于encoding为’hex’的字符串，feross/buffer对调用上述的hexWrite来生成Buffer。关键点来了，这个函数是按两个字符为间隔来调用parseInt方法来进行转换。例如’1.88’生成的Buffer是[1,136], ‘01.8’生成的Buffer则是[1], 为什么是这样呢？</p><p>因为经过按两位分割后，”1.”会被转换为1 “.8”则会返回NaN导致函数退出。<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/parseInt">MDN文档</a>中其实已经描述的非常清楚。</p><blockquote><p>If parseInt encounters a character that is not a numeral in the specified radix, it ignores it and all succeeding characters and returns the integer value parsed up to that point. parseInt truncates numbers to integer values. Leading and trailing spaces are allowed.</p></blockquote><p>好了，至此1.53125这个浮点数就变成了Buffer[1,136] 转化为整数为392。但是如果是1.5的话则为Buffer[1]也就1。</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>1.53125 =&gt; intToHex =&gt; '1.88' =&gt; new Buffer(padToEven(hex.slice(2)), 'hex') =&gt; Buffer[1,136] // 392
1.5 =&gt; intToHex =&gt; '1.8' =&gt; new Buffer(padToEven(hex.slice(2)), 'hex') =&gt; Buffer[1] // 1
</pre></table></code></div></div><p>这样1.53125就摇身一变成为了392，这就天价交易费的由来，一个浮点数的巨变！</p><h2 id="到底想用多少交易费">到底想用多少交易费？<a href="#到底想用多少交易费" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>回到那笔天价的交易来说来说，到底最初设定了多少手续费呢？最后我们尝试推测一下。从链上取得交易的数据，我们发现maxPriorityFeePerGas的值为bd28c8360cb333, 我们已经知道了这是一个错误的浮点数巨变后的值，根据上边的分析原理，小数点后的值可能为”0cb333”。 整数部分大概为bd28c836，转换为整数为3173566518，3Gwei左右感觉相对合理。</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/thinking/'>Thinking</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/blockchain/" class="post-tag no-text-decoration" >blockchain</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=天价交易费的分析与思考-如何复现一笔交易费为7676ETH的交易 - AARONCHEN&url=https://aaronchen.me/posts/tx-fee/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=天价交易费的分析与思考-如何复现一笔交易费为7676ETH的交易 - AARONCHEN&u=https://aaronchen.me/posts/tx-fee/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=天价交易费的分析与思考-如何复现一笔交易费为7676ETH的交易 - AARONCHEN&url=https://aaronchen.me/posts/tx-fee/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/eip-7702/">EIP-7702 浅析</a><li><a href="/posts/Vs1/">数据可视化101-到底该用什么图</a><li><a href="/posts/bitbox02/">BitBox02固件代码浅析</a><li><a href="/posts/blockchain3/">理解 Web 3</a><li><a href="/posts/blokchain1/">区块链是什么鬼?</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/%E5%89%8D%E7%AB%AF/">前端</a> <a class="post-tag" href="/tags/summary/">Summary</a> <a class="post-tag" href="/tags/ios/">IOS</a> <a class="post-tag" href="/tags/blockchain/">blockchain</a> <a class="post-tag" href="/tags/visualization/">visualization</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/react/">react</a> <a class="post-tag" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag" href="/tags/blockchain/">BlockChain</a> <a class="post-tag" href="/tags/blockchain/">Blockchain</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/nonce-reuse/"><div class="card-body"> <em class="timeago small" date="2022-01-09 19:15:00 +0800" >Jan 9, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>惊鸿一瞥：捕猎以太坊黑暗森林中的'那只怪兽'</h3><div class="text-muted small"><p> 作为区块链安全领域从业者，我对密码学和安全一直都有着强烈的兴趣，上周看了一篇非常不错的文章，在和作者联系取得同意后，翻译成了中文，与感兴趣的朋友一起分享一下。下边就是原文: 上周，以太坊黑暗森林里的一只怪兽终于向我露出了他的獠牙。在与tux交流后，我得知了这只怪兽的存在，于是投下了“我的诱饵”，16个小时之后它如期上钩。在Etherscan上看到我消失的ETH，仍旧心有余悸。 这只怪兽一...</p></div></div></a></div><div class="card"> <a href="/posts/web3/"><div class="card-body"> <em class="timeago small" date="2022-01-12 19:15:00 +0800" >Jan 12, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Web什么Three？</h3><div class="text-muted small"><p> 与元宇宙(Metaverse)相比，我一直更喜欢Web3的这个称呼。为什么呢？元宇宙这三个字给人一种太强的“神经感”，想想这句话，今天我在xxx元宇宙认识一个xxx，是不是总觉得哪里不太对。但是Web3的感觉就是更舒服一些。那Web3到底是个什么样子？现在没人能说清楚。我不是魔术师也没法预知未来。但是我还是试图从技术基础的角度是来聊一聊Web的历史，现在和未来。 The history o...</p></div></div></a></div><div class="card"> <a href="/posts/blokchain1/"><div class="card-body"> <em class="timeago small" date="2022-02-08 09:15:00 +0800" >Feb 8, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>区块链是什么鬼?</h3><div class="text-muted small"><p> -&amp;lt;http://www.forexnewsnow.com/top-stories/bitcoin-2016-summary-2017-forecasts/&amp;gt;- 除非你是山顶洞人，我确信你已经听说了比特币（Bitcoins）和区块链。毕竟，它们是热点，是这几天媒体最喜欢的话题，也是年度流行词。连那些从来没有听过加密货币（cryptocurrency）、根本不知道它如何运行的家伙...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/curiosity-good-coder/" class="btn btn-outline-primary" prompt="Older"><p>好奇心, 优秀软件工程师的内核</p></a> <a href="/posts/nonce-reuse/" class="btn btn-outline-primary" prompt="Newer"><p>惊鸿一瞥：捕猎以太坊黑暗森林中的'那只怪兽'</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://aaronchen.me/posts/tx-fee/'; this.page.identifier = '/posts/tx-fee/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://acblog-2.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (typeof modeToggle !== "undefined") { /* modeToggle.addEventListener('click', reloadDisqus); // not pretty for 'color-scheme' */ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/aaron1sme">Aaron Chen</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/%E5%89%8D%E7%AB%AF/">前端</a> <a class="post-tag" href="/tags/summary/">Summary</a> <a class="post-tag" href="/tags/ios/">IOS</a> <a class="post-tag" href="/tags/blockchain/">blockchain</a> <a class="post-tag" href="/tags/visualization/">visualization</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/react/">react</a> <a class="post-tag" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag" href="/tags/blockchain/">BlockChain</a> <a class="post-tag" href="/tags/blockchain/">Blockchain</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-216676446-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-216676446-1'); }); </script>
